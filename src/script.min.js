const video=document.getElementById("video"),stopStreaming=document.querySelector("#stopStreaming"),avatarImgs=document.querySelectorAll(".img-avatar"),avatarImgStart=document.querySelector(".img-avatar-start"),avatarLamp=document.querySelector(".avatar-lamp"),panelBox=document.querySelector("#panelBox"),expressionTxt=document.querySelector("#expression-txt"),expressionTitle=document.querySelector("#expression-title"),loader=document.querySelector(".loading"),status=document.querySelector("#status"),statusCode=document.querySelector("#statusCode"),panel=document.querySelector(".panel"),dateTime=document.querySelector("#date");let gender="",age="",exp="",angry="",neutral="",happy="",surprised="",disgusted="",fearful="",sad="",d=new Date,nD=d.toString(),sD=nD.split(" ").splice(0,5);dateTime.innerText=`${sD[0]} ${sD[1]} ${sD[2]} ${sD[3]} ${sD[4]}`,statusCode.innerHTML="loading module...";let getAvatar=(a,b)=>{(.6<a[0]||1<=a[0])&&("male"===b&&avatarImgs.forEach(b=>{b.style.display=`${a[1]}-male`===b.classList[1]?"block":"none"}),"female"===b&&avatarImgs.forEach(b=>{b.style.display=`${a[1]}-female`===b.classList[1]?"block":"none"}),expressionTxt.innerText=a[1])};Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri("./models"),faceapi.nets.faceLandmark68Net.loadFromUri("./models"),faceapi.nets.faceRecognitionNet.loadFromUri("./models"),faceapi.nets.faceExpressionNet.loadFromUri("./models"),faceapi.nets.ageGenderNet.loadFromUri("./models")]).then(startVideo);function startVideo(){navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(function(a){video.srcObject=a}).catch(function(a){console.error(a)}),statusCode.innerHTML="start video session..."}function stopStreamedVideo(a){let b=a.srcObject,c=b.getTracks();c.forEach(function(a){a.stop()}),a.srcObject=null}video.addEventListener("play",()=>{statusCode.innerHTML="initialize detection..",panel.style.height="400px",avatarImgStart.style.display="block",expressionTxt.innerText="...",setInterval(async()=>{const a=await faceapi.detectAllFaces(video,new faceapi.TinyFaceDetectorOptions).withFaceLandmarks().withFaceExpressions().withAgeAndGender();a[0]&&(gender=a[0].gender,status.style.visibility="hidden",status.style.dislay="none",statusCode.innerHTML="",loader.style.display="none",avatarImgStart.style.display="none",avatarLamp.style.backgroundColor="lightgreen",exp=a[0].expressions,angry=[exp.angry.toFixed(2),"angry"],neutral=[exp.neutral.toFixed(2),"neutral"],happy=[exp.happy.toFixed(2),"happy"],surprised=[exp.surprised.toFixed(2),"surprised"],disgusted=[exp.disgusted.toFixed(2),"disgusted"],fearful=[exp.fearful.toFixed(2),"fearful"],sad=[exp.sad.toFixed(2),"sad"],getAvatar(angry,gender),getAvatar(neutral,gender),getAvatar(happy,gender),getAvatar(surprised,gender),getAvatar(disgusted,gender),getAvatar(sad,gender))},800),stopStreaming.style.display="block",stopStreaming.addEventListener("click",a=>{let b=a.target,c=a.target.classList[1];"icon-cross"===c&&(b.classList.remove("icon-cross"),b.classList.add("icon-refresh"),stopStreamedVideo(video)),"icon-refresh"===c&&(b.classList.remove("icon-refresh"),b.classList.add("icon-cross"),location.reload())})});